# Webarchitects Ansible Synapse Role

[![pipeline status](https://git.coop/webarch/synapse/badges/main/pipeline.svg)](https://git.coop/webarch/synapse/-/commits/main)

This repo contains an Ansible role to install, configure and upgrade [synapse](https://matrix-org.github.io/synapse/latest/), see also the [synapse-server](https://git.coop/webarch/synapse-server) repo for an example of how to use this role.

## Dependencies

This role includes the following Webarchitects roles:

* [acmesh](https://git.coop/webarch/acmesh)
* [postgresql](https://git.coop/webarch/postgresql)

## Synapse configuration

This role uses `debconf` to set the `server_name` and `report_stats` variables, which results in values for these variables being written to files in `/etc/matrix-synapse/conf.d`.

The `form_secret`, `macaroon_secret_key` and `registration_shared_secret` variables are randomly generated by this role, on the server, and then written to files in  `/etc/matrix-synapse/conf.d`.

## Defaults

The following [defaults/main.yml](defaults/main.yml) default variables are set by this role.

#### synapse

`synapse` is a required boolean, set it to `true` to run the tasks in this role, this variable defaults to `false`.

#### synapse_db

`synapse_db` is a dictionary containing the database configuration details, which are written to `/etc/matrix-synapse/conf.d/database.yaml`, for example to use SQLite  rather than PostgreSQL:

```yaml
synapse_db:
  database:
    name: "sqlite3"
    args:
      database: "/var/lib/matrix-synapse/homeserver.db"
```

#### synapse_homeserver

`synapse_homeserver` is a required dictionary that is written, as the main `matrix-synapse` configuration file to `/etc/matrix-synapse/homeserver.yaml` see [the documentation](https://matrix-org.github.io/synapse/latest/usage/configuration/config_documentation.html) for all the options.

The dictionary for `synapse_homeserver` in [defaults/main.yml](defaults/main.yml) contains comments which are omitted when `/etc/matrix-synapse/homeserver.yaml` is written to the server.

The original `/etc/matrix-synapse/homeserver.yaml` file is moved to `/etc/matrix-synapse/.homeserver.original.bak.yaml` before this role overwrites the configuration.

#### synapse_homeserver_combine

`synapse_homeserver_combine` is an optional dictionary that is combined with the `synapse_homeserver` dictionary using the [ansible.builtin.combine filter](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/combine_filter.html) with the `list_merge` parameter set to `replace` and `recursive` set to `true`, this means that individual variables in the `synapse_homeserver` dictionary can be replaced without having to redefine all the defaults.

By default `synapse_homeserver_combine` is not defined, an example of how it can be used, to set the `web_client_location` variable in `/etc/matrix-synapse/homeserver.yaml`:

```yaml
synapse_homeserver_combine:
  web_client_location: "https://{{ element_domain }}/"
```

Internally to this role, the result of combining `synapse_homeserver` and `synapse_homeserver_combine` is defined as `synapse_homeserver_proposed_config`, the existing `/etc/matrix-synapse/homeserver.yaml` confguration is read and defined as `synapse_homeserver_existing_config`.

#### synapse_server_name

`synapse_server_name` is a required domain name that is used for the [server_name](https://matrix-org.github.io/synapse/latest/usage/configuration/config_documentation.html#server_name), this is used for addresses, for example if the `server_name` was `example.com`, usernames on your server would be in the format `@user:example.com`.

#### synapse_source

`synapse_source` is a required variable for the source of the `matrix-synapse` package, this curently defaults to `debian`, in the future `synapse` might also be supported for installing the upstream package.

## Single sign-on

Note that if `synapse_homeserver_combine` is defined then variables set in `synapse_homeserver` can't use Jinja2 escaping, for example:

```yaml
        localpart_template: "{% raw %}{{ user.preferred_username }}{% endraw %}"
```

As it will result in Ansible looking for the `user` variable, for this reason the default SSO settings are written to `/etc/matrix-synapse/sso_example.yaml`, move this file to `/etc/matrix-synapse/conf.d/sso.yaml` and edit it as required to configure SSO.

## Notes

Generate an example config file:

```bash
usr/bin/python3 -m synapse.app.homeserver --config-path=/etc/matrix-synapse/test.yml \
  --generate-config --report-stats=no -H $(hostname -f)
```
